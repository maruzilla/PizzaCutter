<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camera with Real-Time Drawing</title>
  <style>
    canvas, video {
      position: absolute;
      touch-action: pan-x pan-y;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <canvas id="overlay"></canvas>

<script>
  // カメラ映像を取得
  const video = document.getElementById('camera');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  let arcX = 320;		// Center X
  let arcY = 240;		// Center Y
  let arcD = 220;		// Diameter
  let angY = -60;		// angle Y
  let ep = 5;			// equal parts to divide

  try {
    const element = document.documentElement;

    // 1. 全画面表示をリクエスト
    if (element.requestFullscreen) {
      element.requestFullscreen();
    } else if (element.webkitRequestFullscreen) { /* iOS Safari 対策 */
      element.webkitRequestFullscreen();
    }

    // 2. 向きを縦(portrait)に固定
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock("portrait-primary");
      console.log("縦向きに固定されました");
    }
    
    // 3. スクロールをロック (CSS制御)
    // overflow: hidden でスクロールバーを消し、
    // touch-action: none でモバイルのオーバースクロール（バウンス）を防ぐ
    document.body.style.overflow = "hidden";
    document.body.style.touchAction = "none";

  } catch (error) {
    console.error("エラーが発生しました:", error);
  }

  // カメラ映像の設定
  // navigator.mediaDevices.getUserMedia({ video: true })
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }, // 背面カメラ
    // video: { facingMode: { exact: "environment" } }, // 背面カメラ
    audio: false
  })
    .then((stream) => {
      video.srcObject = stream;
      video.addEventListener('loadedmetadata', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        console.log('canvas.width: ', canvas.width);
        console.log('canvas.height: ', canvas.height);
        arcX = canvas.width / 2;
        arcY = canvas.height / 2;
        arcD = arcY * 0.62;	// 0.95
        drawShapes();
      });
    })
    .catch((err) => {
      console.error('カメラの起動に失敗しました:', err);
    });

  // 図形をリアルタイムで描画
  function drawShapes() {
    ctx.clearRect(0, 0, canvas.width, canvas.height); // 前のフレームをクリア

    ctx.beginPath();
    ctx.lineWidth = 2;       // 線の太さを2pxに設定
    ctx.ellipse(arcX, arcY,  arcD, arcD,  0.1, 0, Math.PI*2); 	// (x,y, 半径X,半径Y, 回転, 開始角度, 終了角度)
    
    for (let i = 0; i < ep; i++) {
      ctx.moveTo(arcX, arcY); // 中心から
      ctx.lineTo(arcX + Math.sin(2*i*Math.PI/ep)*arcD, arcY - Math.cos(2*i*Math.PI/ep)*arcD); // 計算した点まで線を引く
    }
    ctx.strokeStyle = 'rgba(255,255,255, 0.75)'; 	// 線の色, 透過率 75%
    ctx.stroke(); // 線を描画

    //requestAnimationFrame(drawShapes); // 次のフレームを描画

  }
</script>
</body>
</html>
